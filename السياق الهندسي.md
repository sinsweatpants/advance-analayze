1) SYSTEM — النظام

الاسم: [اسم النظام]

الغرض: تحليل السيناريو قبل الدخول في التنفيذ لتقليل المخاطر الإبداعية والإنتاجية عبر تقارير قياسية وقياسات كمية/نوعية قابلة للتفسير.

أصحاب المصلحة: الكتاب/المنتج/المخرج/قسم التطوير/قسم الجدولة/التمويل.

مؤشرات النجاح (KPIs): تقليل دورات إعادة الكتابة بنسبة [X%]، رفع دقة اكتشاف المخاطر السردية/الإنتاجية إلى [Y%]، خفض زمن التقييم إلى [Z] دقائق/سيناريو.

2) SCOPE — النطاق

داخل النطاق: تحليل النص الكامل للسيناريو (Arabic/RTL مدعوم)، تقسيم المشاهد، القياس الأسلوبي، نمذجة الموضوعات، أقواس المشاعر، الشبكات الدرامية للشخصيات، تحليلات طولية للمسارات، مؤشرات مخاطر إنتاجية (مشاهد مُكلفة/ليلي/خارج/مؤثرات)، تقارير قابلة للتصدير.

خارج النطاق (النسخة الأولى): توليد نصوص بديلة، التنبؤ بالإيرادات، اختيار ممثلين آليًا.

3) OUTPUTS — المخرجات

تقرير «ملف مخاطر ما قبل التنفيذ» (Pre-Prod Risk Dossier): تجميعة من:

Story Progression Chart (مسار التوتر/الشكل 0-100 لكل مشهد).

Sentiment Arcs (أقواس المشاعر المُمهدة وغير المُمهدة) مع ملاحظات حول السخرية والغموض اللغوي. 

تحليل متقدم

Topic Landscape (مشهد الموضوعات: LDA/BERTopic). 

تحليل متقدم

 

تحليل متقدم

Style Fingerprint (بصمة أسلوبية/مؤشرات أسلوب). 

تحليل متقدم

Character Network (شبكة العلاقات واتجاهها عبر الزمن). 

تحليل متقدم

مؤشرات إنتاجية: لقطات ليلية/خارجية، كثافة المواقع، كثافة الشخصيات في المشهد، «تكلفة تقديرية» بالمستوى النسبي.

4) DATA — المدخلات

ملفات: PDF/FDX/Docx/Plain Text.

طبقة استخلاص: OCR عند الحاجة + Normalization (Unicode/RTL/Punct/Diacritics).

تعريف الوحدة التحليلية: Scene كوحدة أولية + Beat اختياريًا.

هل تفضّل عرضًا «خطوة بخطوة» أم «نظرة شاملة»؟ إلى أن تُحدّد تفضيلك، أقدّم لك أدناه نسخة مطوّرة وحديثة وأكثر كفاءة من الجزأين (5) و(6) بصياغة جاهزة للنسخ في وثيقتك الأساسية، مع احتفاظ كامل بالبنية والمنطق، وإضافة تحسينات عملية قابلة للتنفيذ.

# 5) PIPELINE — خطّ الأنابيب التحليلي (نسخة مطوّرة 2025)

## 5.0 الاستيعاب والتهيئة اللغوية (إضافة موصى بها قبل 5.1)

* **استخلاص النص**: FDX/Final Draft، PDF (مع OCR عربي عند الحاجة)، DOCX/TXT.
* **تطبيع عربي/RTL**: إزالة التطويل، توحيد علامات الترقيم، توحيد الأرقام (هندي/عربي)، توحيد المسافات، الكشف المبكر عن لغة/ازدواج (عربي/إنجليزي).
* **تنميط الحقول الأولية**: `script_id`, `scene_id`, `source_page`, `char_aliases`, `location_aliases`.

## 5.1 التقسيم والتهيئة

* **كشف عناوين المشاهد (INT/EXT/المكان/الزمن)** بمنهج هجين:

  1. **قواعد نحوية-طباعية دقيقة** (Regex/Grammar) تغطي الصيغ العربية الشائعة وبدائلها.
  2. **وسم تسلسلي تعلّمي** (BiLSTM-CRF أو Transformer-CRF) لتمييز HEAD/Action/Dialogue/Parenthetical على مستوى السطر، مع طبقة تصحيح لاحقة (Post-Processing) لحالات الالتباس.
* **تقسيم داخلي إلى Beats**:

  * **TextTiling/LSA** كبداية، مع **تجزئة دلالية مُعزّزة بالتمثيلات** (e.g., multilingual sentence embeddings) لضبط تغيّر الموضوع/الهدف داخل المشهد.
* **حلّ الشخصيات والكنى (Character Canonicalization)**:

  * تطبيع الأسماء (اختصارات/كنى/صيَغ نداء) + **تجميع دلالي** لأسماء متقاربة، مع جدول تعيين `alias → canonical_name`.
* **ربط الحوار بالمتكلم (Who-said-what)**:

  * تصنيف سطري مخصّص للحوار/الفعل/الترويسات/الملاحظات، مع استدلال المتكلم من السياق القريب والـ Parentheticals.
* **ترقيم موحّد وميتا**: ترقيم متّسق للمشاهد والـ Beats، واستخراج `(location, time_of_day, characters[])` لكل مشهد.

## 5.2 الخصائص التقليدية (Feature-based) — مُحدّثة

### 5.2.a قياس أسلوبي متقدّم

* **ثروة مفردات متينة**: MTLD/HDD بدل TTR الخام، و**Yule’s K** لقياس تشتّت المفردات.
* **طول الجملة والإيقاع**: متوسط/تباين/انحراف، ونِسَب علامات الوقف/الوصل.
* **سلاسل وظيفية عربية**: تكرار الكلمات الوظيفية العربية (حروف العطف/الجر/النفي) وأنماط POS (وسوم صرفية) عبر مُحلّل صرفي موثوق.
* **سمات تركيبية**: عمق الشجرة النحوية، متوسط الدرجات التابع/المتبوع، نِسَب التضمين/الجمل الاعتراضية.
* **سمات خطابية** (حيث يُمكن رصدها نصيًا): وجود أقواس تفسيرية/تعقيبية، كثافة التوجيهات المسرحية، مؤشرات التورية/المفارقة المعجمية.

### 5.2.b كلمات مفتاحية وعبارات

* **Keyphrase/KeyBERT-style** مع تصحيح للطول، وتخفيض الأشكال المكررة (Lemmatization)، وتصفية التكرارات عبر تطابق دلالي.

### 5.2.c مؤشرات حمل إنتاجي (Production Load)

* طول المشهد، تراكم الشخصيات، تبدّل المواقع، خارج/داخل، ليل/نهار، وجود مؤثرات/مطاردات/حشود؛ تُحوَّل إلى **مؤشرات كمية** تُطعم لاحقًا نماذج الخطر.

## 5.3 نمذجة الموضوعات — مُحسّنة

* **مسار ثنائي المستويات**:

  1. **LDA/NMF** لقراءة بعيدة المدى وتماسك موضوعي إجمالي مع تشذيب ثنائي/ثلاثي (Bigrams/Trigrams).
  2. **BERTopic/Embeddings + HDBSCAN** لتجميع دلالي سياقي للمقاطع القصيرة (Scenes/Beats)، مع **UMAP** للاختزال البُعدي.
* **ديناميكية الموضوع**: تتبّع توزّع الموضوعات عبر تسلسل المشاهد لإخراج **خرائط تغيّر موضوعي** (Topic Shift Maps) تُستخدم لاحقًا في مسار الدمج.
* **حراسة الجودة**: حدّ أدنى للتوكنات لكل وحدة تحليل؛ دمج مشاهد قصيرة قبل النمذجة لتفادي Topics هشّة.

## 5.4 تحليل المشاعر — مُعزَّز بالدقة والتسامح مع السخرية

* **طبقة هجينة**:

  * **معجمية**: قواميس استقطاب عربيّة مكيّفة للسياق الدرامي (وزن خاص للإنكار/التقليل/التضاد).
  * **محولات**: مصنّف مشاعر/انفعالات متعدد الأبعاد (سرور/خوف/غضب/حزن…) على مستوى الجملة والمشهد.
* **كشف السخرية والمفارقة**:

  * مصنّف خاص للسخرية (Irony/Sarcasm) يُعدّل درجات الاستقطاب النهائية عبر **دالة تصحيح**:
    `polarity_final = f(polarity_base, sarcasm_score, negation_span, intensifiers)`
* **أقواس مشاعر ناعمة**:

  * تسوية زمنية (LOESS/Kalman) وتزامن مع الـ Beats، مع إنتاج منحنى «خام» وآخر «مُمهد» للمقارنة.

## 5.5 المحولات (Transformers) — أداء وموثوقية

* **نمذجة هرميّة للنص الطويل**:

  * **تشفير وحدات قصيرة** (جمل/Beats) بمحولات قياسية (BERT/RoBERTa)، ثم **مجمّع علوي** (Transformer/GRU) على مستوى المشهد/السيناريو.
  * بديل: **Longformer/BigBird** للنص الكامل عندما تسمح الموارد.
* **استراتيجية الطول والنافذة المنزلقة**:

  * **Chunking** مع تداخل مضبوط (stride) + **تجميع تنبؤات** (Logit Averaging/Max-Margin Voting).
* **ضبط الموارد**:

  * **تحويلة دقيقة منخفضة الموارد** (LoRA/QLoRA) عند الحاجة، **كمّنة INT8/INT4** للاستدلال، **تخزين مؤقّت للتضمينات** (Embedding Cache) للمشاهد غير المعدّلة.
* **معايرة المخرجات**:

  * Platt/Isotonic Calibration للإتاحة **احتمالات مُعايرة** قابلة للمقارنة عبر المهام.

## 5.6 دمج الطبقات (Model Fusion) — موثوقية مع ضمانات

* **Stacked Ensemble**:

  * مستوى أوّل: خصائص أسلوبية + موضوعات + مشاعر + محولات.
  * مستوى ثانٍ: ميتا-مصنّف (LogReg/GBDT) يدمج النتائج ويُخرِج **مؤشر المخاطر/الفرص**.
* **بوابة قرار (Gating)**:

  * اختيار المسار الأمثل حسب خصائص النص (الطول/التناثر/التعليقات المسرحية).
* **ثقة وعدم يقين**:

  * قياس Entropy/Variance عبر **Self-Consistency**، وتطبيق **Conformal Prediction** لإرجاع **مجموعات تنبؤ** مع ضمان تغطية.
* **تطبيع عبر النصوص**:

  * Normalization عبر Z-Score داخل السيناريو، ثم Robust Scaling على مستوى مجموعة السيناريوهات لضمان قابلية المقارنة.

## 5.7 الحوسبة الدلالية لما قبل الإنتاج — أدقّ وأوسع

* **مؤشرات مخاطر مُفصّلة**:

  * تكلفة نسبية = g(طول المشهد، عدد الشخصيات، خارج/داخل، ليل/نهار، تغيّر مواقع، إشارات VFX/مجموعة خاصة).
  * **مؤشر تعقيد تنفيذي**:
    `ExecComplexity = α*LocationSwitch + β*CrowdIntensity + γ*NightExt + δ*Stunts/VFX + ε*DialogueDensity`
* **مواءمة سرد/إنتاج**:

  * ربط قمم أقواس المشاعر مع تبدّلات الموضوع والعلاقات، وتحديد **النوافذ الذهبية** للتصوير (حيث التغيّر السردي مرتفع لكن الحمل الإنتاجي منخفض).
* **شبكة الشخصيات الزمنية**:

  * رسم **Graph(t)** للعلاقات عبر الزمن، مع كشف **ذيول/قِمم** التوتّر العلائقي واستتباعه بمخاطر لوجستية (تجميع ممثلين، انتقال مواقع).

## 5.8 ضمان الجودة والأداء (اختياري لكنه مُستحسن)

* **اختبارات ذهبية** لعَيّنات مشاهد موسومة يدويًا.
* **مؤشرات زمنية**: سقف زمني لكل مرحلة، تنبيهات عند الانحراف.
* **مسارات تعافٍ**: تجاهل وحدات فاشلة مع تسجيل السبب، وتوليد تقرير تحذيري بديل.

---

# 6) INTERPRETABILITY — قابلية التفسير (نسخة مُعزّزة)

## 6.1 مستويات التفسير

* **مستوى الوثيقة**: لماذا حاز السيناريو على نمط خطر معيّن؟ ملخص أعلى الميزات والموضوعات المحرِّكة.
* **مستوى المشهد**: أهم السطور/العبارات/السمات التي رفعت أو خفّضت التقييم (قائمة أدلة مُرتّبة).
* **مستوى السطر/العبارة**: تظليل مقاطع نصية مع **درجات مساهمة** وإظهار سياق الجملة.

## 6.2 طرق التفسير الموثوقة

* **للخصائص التقليدية**:

  * **SHAP**/Permutation Importance لقياس مساهمة كل سمة (Stylometry/Topics/Load) في القرار.
* **للمحولات**:

  * **Integrated Gradients** و**LRP** لاستخراج **مبرّرات استخراجية** (Extractive Rationales) قابلة للعرض.
  * **Attention Rollout** للاستكشاف فقط (توضيحي، ليس دليلاً وحيدًا).
* **معايرة الصدقية**:

  * ربط كل تفسير **بدرجة ثقة**، وإرجاع **مجموعة تنبؤ** (Conformal Set) عند عدم اليقين العالي.

## 6.3 شواهد وأمثلة مُقارنة

* **أمثلة مجاورة** (Nearest-Neighbor Prototypes): عرض مشاهد مُشابهة من قاعدة معيارية مع نتائجها لتكوين حدس نوعي.
* **قبل/بعد**: إبراز الفرق السردي/الأسلوبي عند تطبيق اقتراحات تحريرية (Counterfactuals).

## 6.4 اقتراحات مضادّة (Counterfactual Explanations)

* توليد تعديلات حدّية قابلة للتنفيذ تُخفض «مؤشر خطر» محدّدًا، مثل: تقليص كثافة شخصيات المشهد، تبديل موقع ليلي خارجي إلى داخلي، تخفيف التبدّلات المتتالية في المواقع.

## 6.5 واجهة عرض التفسير (مواصفات موجزة)

* **Heatmaps** فوق النصّ مع شريط تمرير الحساسية.
* **لوحة أدلة**: جدول Top-K أدلة لكل حكم نموذج، مع روابط قافزة إلى المواضع في النص.
* **تبديل عدسات**: خصائص تقليدية/محولات/دمج، لإظهار اختلاف مصادر القرار.
* **تصدير شفاف**: JSON/CSV للأدلة، وPDF مفسَّر مع هوامش توضيحية.

7) ARCHITECTURE — البنية

Frontend (Next.js/React, RTL-ready): لوحات Story/Topics/Sentiment/Network + تصدير PDF/CSV.

API (FastAPI أو Node/Express): /ingest, /analyze, /explain, /reports, /export.

ML Services: خدمة «تحليلات كلاسيكية»، خدمة «محولات»، خدمة «دمج».

Storage: MinIO/S3 (نصوص/تقارير)، PostgreSQL (مشاهد/خصائص/نتائج).

Orchestrator: صف مهام (RQ/Celery/BullMQ) + مراقبة (Prometheus + Grafana).

8) ENDPOINTS — مواصفات مختصرة

POST /ingest {file, lang, metadata}

POST /analyze {script_id, tasks:[stylometry,topics,sentiment,transformers]}

GET /reports/:id → JSON (StoryChart, Topics, SentimentArc, StyleProfile, CharacterNetwork)

POST /explain {artifact_id, method:[lime|shap|attention]}

9) DATA SCHEMAS — مخططات

Scene: {id, number, heading, location, time, characters[], tokens, duration_est}

StyleProfile: {scene_id, metrics:{avg_sentence_len, type_token_ratio, yules_i, punctuation…}}

Topics: {scene_id, method:[lda|bertopic], distribution[], top_terms[]}

SentimentArc: {scene_id, raw_polarity, smoothed_curve}

CharacterNetwork: {nodes:[char], edges:[{source,target,weight,type,time_span}]}

RiskIndicators: {scene_id, risk:{cost_level, night_ext, crowd_intensity}, notes}

10) EVALUATION — التقييم

مصادقة بشرية على عيّنات مشاهد (Ground Truth) لكل مهمة.

مقاييس: F1 (تصنيف/مشاعر)، NPMI/Coherence (موضوعات)، Agreement (Cohen’s κ) مع المحللين.

تقارير A/B: (قاموس فقط) vs (BERT فقط) vs (هجين) لأقواس المشاعر. 

تحليل متقدم

11) SECURITY & ETHICS — الحوكمة

خصوصية النصوص وحقوقها، سجلات تدقيق، إخفاء هوية عند التعلّم.

تحيزات لغوية/أسلوبية: فحوص تكافؤ عبر النوع/اللهجة، وتقرير تحيز رُبع سنوي.

12) DELIVERY PLAN — خطة التنفيذ (Build→Assemble→Grade→Mix→Render→Export)

Build: إعداد المشروع، وحدات RTL، خطوط عربية، CI لنظافة الشفرة.

Assemble: طبقة ingest & normalize، مقسم المشاهد، استخراج خصائص كلاسيكية (Stylometry/Topics/Sentiment-Lex).

Grade: دمج نماذج المحولات (BERT/DistilBERT) + مسار Longformer للنص الكامل؛ ضبط المعلمات وفق محدوديات الطول. 

تحليل متقدم

Mix: تكامل الطبقات (Ensemble) وتوليد مؤشرات المخاطر/الفرص.

Render: لوحات وتصورات (Story Chart/Arc/Network/Topics) + واجهة تفسير.

Export: PDF/CSV، وبروتوكول مشاركة تقرير «Pre-Prod Risk Dossier».

13) DoD — تعريف الاكتمال

تحليل سيناريو نموذجي ≤ [X] دقيقة مع تقرير كامل وشرح موضعي.

دقة ≥ [Threshold] في مهام التصنيف/المشاعر، وتماسك موضوعات ≥ [Coherence].

توفّر تفسير محلي لكل توصية عالية التأثير (Top-K مخاطر/فرص).

14) OPERATIONS — التشغيل

تتبّع زمن التنفيذ لكل مهمة، ومراقبة الموارد (GPU/CPU).

نماذج قابلة للتحديث الساخن (versioned models + rollback).

لوائح أخطاء بأولوية: P0 (انهيار تحليل)، P1 (تأخر زائد)، P2 (انحراف دقة).

15) RISKS & MITIGATIONS — المخاطر والمعالجات

طول النص: اعتماد Longformer أو تجزئة متداخلة وتجميع موثوق. 

تحليل متقدم

الأجرأة: تعريفات تشغيلية واضحة للمفاهيم الأدبية وربطها بالخصائص/المؤشرات. 

تحليل متقدم

الغموض/السخرية: نهج هجين للمشاعر + مراجعة بشرية لنقاط التعارض. 

تحليل متقدم

16) APPENDIX — مواصفات التحليلات الأساسية

Story Progression (0-100):

shape_value(scene) = w1*Δsentiment + w2*topic_shift + w3*style_shift + w4*conflict_signals

تسوية منحنى القيم (Savitzky–Golay أو EMA) ومواءمته مع الحَبَكات الثانوية.

Topics: LDA للاتساع، BERTopic للعمق الدلالي؛ تقاطع النتائج للنزاهة. 

تحليل متقدم

Sentiment Arcs: منحنى خام (محول) ومنحنى مُمهد (قاموس) + مقارنة/دمج. 

تحليل متقدم

Character Network: استخراج الكيانات والعلاقات ومساراتها الزمنية. 

تحليل متقدم